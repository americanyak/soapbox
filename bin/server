#!/usr/bin/env node

console.log('\n\n');
console.log('      ___ ___ ___ ___| |_ ___ _ _');
console.log('     |_ -| . | .\'| . | . | . |_\'_|');
console.log('     |___|___|__,|  _|___|___|_,_|');
console.log('                 |_|');
console.log('\n\n');

// https://github.com/nko4/website/blob/master/module/README.md#nodejs-knockout-deploy-check-ins
require('nko')('v9cXBZpDnEFeug5f');

var rootDir = process.cwd();

var http = require('http');
// var path = require('path');
var express = require('express');
var stylus = require('stylus');
var app = exports.app = express();

var config = require(rootDir + '/config');
var nodeEnv = config.get('ENVIRONMENT');
var port = nodeEnv === 'production' ? 80 : config.get('PORT');
// console.log(port, nodeEnv);

// var server;

http.createServer(function(req, res) {
	// http://blog.nodeknockout.com/post/35364532732/protip-add-the-vote-ko-badge-to-your-app
	var voteko = '<iframe src="http://nodeknockout.com/iframe/xyzzy" frameborder=0 scrolling=no allowtransparency=true width=115 height=25></iframe>';

	res.writeHead(200, {
		'Content-Type': 'text/html'
	});
	res.end('<html><body>' + voteko + '</body></html>\n');
}).listen(port, function(err) {
	if (err) {
		console.error(err);
		process.exit(-1);
	}

	// if run as root, downgrade to the owner of this file
	if (process.getuid() === 0) {
		require('fs').stat(__filename, function(err, stats) {
			if (err) {
				return console.error(err);
			}
			process.setuid(stats.uid);
		});
	}

	console.log('Server running at http://0.0.0.0:' + port + '/');
});